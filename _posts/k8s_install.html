<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 9.5.7 (464280)"/><meta name="keywords" content="K8s安装文档"/><meta name="author" content="135kcueo873"/><meta name="created" content="2021-08-26 02:49:46 +0000"/><meta name="source" content="desktop.win"/><meta name="source-application" content="yinxiang.win32"/><meta name="source-url" content="file:///D:\F\k8s\搭建一套完整的K8s集群v1.20版本\部署一套完整的K8s高可用集群（kubeadm-V1.20）%20.docx"/><meta name="updated" content="2021-08-27 15:17:24 +0000"/><title>k8s  1.20  kubeadm形式安装 快速部署文档</title></head><body><div><div>一、节点规划</div><div>    </div><div>     Master: </div><div>        - 10.0.158.55  master01</div><div>        - 10.0.158.56  master02</div><div>        - 10.0.158.57  master03</div><div>     ETCD:</div><div>        - 10.0.158.55</div><div>        - 10.0.158.56</div><div>        - 10.0.158.57   </div><div>      Node:</div><div>        -  10.0.158.51  node01</div><div><span style="font-size: unset; color: unset; font-family: unset; --inversion-type-color: simple;">        -  10.0.179.33  node02</span></div><div><span style="font-size: unset; color: unset; font-family: unset; --inversion-type-color: simple;">        -  10.0.179.34  node03</span></div><div><span style="font-size: unset; color: unset; font-family: unset; --inversion-type-color: simple;">        -  10.0.179.36  node04</span></div><div><span style="font-size: unset; color: unset; font-family: unset; --inversion-type-color: simple;">        -  10.0.179.37  node05 </span></div><div><span style="font-size: unset;"><br/></span></div><div><span style="font-size: unset; color: unset; font-family: unset; --inversion-type-color: simple;">     软件版本</span></div><div><span style="font-size: unset; color: unset; font-family: unset; --inversion-type-color: simple;">           docker:   1.19.3 </span></div><div><span style="font-size: unset; color: unset; font-family: unset; --inversion-type-color: simple;">           kubectl:   </span>v1.20.0</div><div>           os:           centos7</div><div><br/></div><div>二、节点初始化</div><h3><span style="font-family: 宋体; line-height: 173%;">1.配置</span> <span style="font-family: 宋体; line-height: 173%;">remote-hosts</span> <span style="font-family: 宋体; line-height: 173%;">文件，包含</span><span style="font-family: 宋体; line-height: 173%;">Master</span> <span style="font-family: 宋体; line-height: 173%;">和</span> <span style="font-family: 宋体; line-height: 173%;">worker</span> <span style="font-family: 宋体; line-height: 173%;">节点</span><span style="font-family: 宋体; line-height: 173%;">IP</span></h3><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mkdir -p /root/k8s_env &amp;&amp; cd /root/k8s_env    # 中控机的工作目录</div><div>cat &gt; remote-hosts &lt;&lt;EOF</div><div>10.0.158.55</div><div>10.0.158.56</div><div>10.0.158.57</div><div>10.0.158.51</div><div>10.0.179.33</div><div>10.0.179.34</div><div>10.0.179.36</div><div>10.0.179.37</div><div>EOF</div></div><div><span style="font-size: 11pt;"><br/></span></div><div><span style="font-size: 11pt; font-family: 宋体;">2.配置remote-masters文件 - 添加所有Master的IP</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cat &gt; remote-masters &lt;&lt;EOF</div><div>10.0.158.55</div><div>10.0.158.56</div><div>10.0.158.57</div><div>EOF</div></div><div style="margin-top: 1em; margin-bottom: 1em;">3.生成ssh密钥对</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>ssh-keygen -t rsa                          #生成SSH密钥对</div><div>yum -y install sshpass openssh-clients     #安装相关依赖工具</div></div><div><span style="font-size: 11pt;"><br/></span></div><div style="margin-top: 1em; margin-bottom: 1em;">4.配置ssh互信并验证</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>for host in $(cat remote-hosts)</div><div>do</div><div>echo $host</div><div>sshpass -p "ABCabc123" ssh-copy-id -o StrictHostKeyChecking=no root@${host}</div><div>echo</div><div>done</div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>for host in $(cat remote-hosts)</div><div>do</div><div>echo $host</div><div>ssh $host " uname -r "</div><div>echo</div><div>done</div></div><div style="margin-top: 1em; margin-bottom: 1em;">更改节点密码，统一设置为 ABCDefg987  #根据自已需求，可不做</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>for host in $(cat remote-hosts)</div><div>do</div><div>echo $host</div><div>ssh $host "echo "ABCDefg987" | passwd root --stdin &gt; /dev/null 2&gt;&amp;1"</div><div>echo</div><div>done</div></div><div style="margin-top: 1em; margin-bottom: 1em;">5.配置hosts解析</div><div style="margin-top: 1em; margin-bottom: 1em;">生成host解析文件</div><div style="margin-top: 1em; margin-bottom: 1em;">Step 1    文件中 #k8sHostStart 与 #k8sHostEnd 注释步骤不可忽略，以方便后续重复操作的清除处理</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mkdir tmp</div><div>echo "#k8sHostStart" &gt; tmp/k8s_host</div></div><div style="margin-top: 1em; margin-bottom: 1em;">Step 2</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># 当内网域名没有配置好时，可以手动把域名和LB的映射写入hosts文件中</div><div>echo "10.0.158.250  www.lanskj.com" &gt;&gt; tmp/k8s_host</div><div>echo "10.0.158.249  web.lanskj.com" &gt;&gt; tmp/k8s_host</div></div><div style="margin-top: 1em; margin-bottom: 1em;">Step 3</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>for host in $(cat remote-hosts)</div><div>do</div><div>   hostname=$(ssh $host "hostname")</div><div>   echo $host $hostname &gt;&gt; tmp/k8s_host</div><div>done</div></div><div style="margin-top: 1em; margin-bottom: 1em;">Step 4</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>echo "#k8sHostEnd" &gt;&gt; tmp/k8s_host</div><div>cat tmp/k8s_host</div></div><div style="margin-top: 1em; margin-bottom: 1em;">Step 5 分发hosts解析文件，并合并到远程主机的 /etc/hosts</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>for host in $(cat remote-hosts)</div><div>do</div><div>    scp tmp/k8s_host $host:/tmp/</div><div>    ssh $host "sed -i '/^#k8sHostStart/,/^#k8sHostEnd/d' /etc/hosts"</div><div>    ssh $host "cat /tmp/k8s_host &gt;&gt; /etc/hosts"</div><div>done</div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: unset; color: unset; font-family: unset; --inversion-type-color: simple;">Step 6 验证 hosts 配置是否已添加到远程主机</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>for host in $(cat remote-hosts)</div><div>do</div><div>    echo $host</div><div>ssh $host "cat /etc/hosts"</div><div>echo</div><div>done</div></div><div style="margin-top: 1em; margin-bottom: 1em;">6.内核升级和系统参数优化</div><div style="margin-top: 1em; margin-bottom: 1em;">   Step 1 优化文件打开数目和用户进程限制</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># 检查文件打开数目</div><div>for host in $(cat remote-hosts)</div><div>do</div><div>echo $host</div><div>ssh $host "ulimit -a"</div><div>echo</div><div>done</div><div># 判断是否优化过，如未进行优化则执行下面命令进行优化</div><div>for host in $(cat remote-hosts)</div><div>do</div><div>ssh $host "echo "ulimit -n 65535" &gt;&gt;/etc/profile"</div><div>ssh $host "source /etc/profile"</div><div>    ssh $host "echo "* - nofile 65535" &gt;&gt; /etc/security/limits.conf"</div><div>    ssh $host "echo "* - noproc 65535" &gt;&gt; /etc/security/limits.conf"</div><div>ssh $host "echo "* soft nproc 40960" &gt;&gt; /etc/security/limits.d/20-nproc.conf"</div><div>    ssh $host "echo "root soft nproc unlimited" &gt;&gt; /etc/security/limits.d/20-nproc.conf"</div><div>done</div></div><div style="margin-top: 1em; margin-bottom: 1em;">    Step 2 升级内核到5.0.13 # 提前上传rpm 包到/tmp目录下</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>for host in $(cat remote-hosts)</div><div>do</div><div>    echo $host</div><div>ssh $host "yum -y install /tmp/kernel-ml-devel-5.0.13-1.el7.elrepo.x86_64.rpm"</div><div>    ssh $host " yum -y install /tmp/kernel-ml-5.0.13-1.el7.elrepo.x86_64.rpm"</div><div>ssh $host "grub2-set-default  0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg"</div><div>ssh $host "grubby --default-kernel"</div><div>done</div><div>for host in $(cat remote-hosts)</div><div>do</div><div>echo $host"</div><div>ssh $host "sync &amp;&amp; sync &amp;&amp; sync &amp;&amp; reboot"</div><div>done</div></div><div style="margin-top: 1em; margin-bottom: 1em;">   Step 3 重启后验证内核和文件打开数</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cd /root/k8s_env                   # 重启后需要进入工作目录</div><div>for host in $(cat remote-hosts)</div><div>do</div><div>echo $host</div><div>ssh $host "uname -r"</div><div>ssh $host "ulimit -n"</div><div>done</div></div><div style="margin-top: 1em; margin-bottom: 1em;">  7.系统初始化配置</div><div style="margin-top: 1em; margin-bottom: 1em;">    Step 1 配置通用的  <span style="font-size: 10.5pt; font-family: 宋体;">kubernetes.conf配置</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cat &gt; tmp/kubernetes.conf &lt;&lt;EOF</div><div>net.bridge.bridge-nf-call-iptables=1</div><div>net.bridge.bridge-nf-call-ip6tables=1</div><div>net.ipv4.ip_forward=1</div><div>vm.swappiness=0</div><div>vm.overcommit_memory=1</div><div>vm.panic_on_oom=0</div><div>net.ipv4.tcp_keepalive_time = 600</div><div>fs.inotify.max_user_instances=8192</div><div>fs.inotify.max_user_watches=1048576</div><div>fs.file-max=52706963</div><div>fs.nr_open=52706963</div><div>net.ipv6.conf.all.disable_ipv6=1</div><div>net.netfilter.nf_conntrack_max=2310720</div><div>net.ipv4.neigh.default.gc_thresh1 = 80000</div><div>net.ipv4.neigh.default.gc_thresh2 = 90000</div><div>net.ipv4.neigh.default.gc_thresh3 = 100000</div><div>EOF</div></div><div style="margin-top: 1em; margin-bottom: 1em;">   Step 2 配置通用的IPVS配置。如果使用iptables做转发可以忽略</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cat &gt; tmp/ipvs.modules &lt;&lt;EOF</div><div>#!/bin/bash</div><div>modprobe -- ip_vs</div><div>modprobe -- ip_vs_rr</div><div>modprobe -- ip_vs_wrr</div><div>modprobe -- ip_vs_sh</div><div>modprobe -- nf_conntrack_ipv4</div><div>modprobe -- br_netfilter</div><div>EOF</div></div><div style="margin-top: 1em; margin-bottom: 1em;">    Step 3 安装依赖包</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>for host in $(cat remote-hosts)</div><div>do</div><div>    echo $host</div><div>    ssh $host "yum install -y conntrack ntpdate ntp ipvsadm ipset jq iptables sysstat libseccomp bash-completion nfs-utils rpcbind vim telnet lrzsz bind-utils "</div><div>ssh $host "systemctl enable rpcbind &amp;&amp; systemctl start rpcbind"</div><div>done</div></div><div style="margin-top: 1em; margin-bottom: 1em;">   Step  4 配置分发系统初始化</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>for host in $(cat remote-hosts)</div><div>do</div><div>    echo $host</div><div>ssh $host "systemctl disable firewalld"       </div><div>    ssh $host "setenforce 0"</div><div>    ssh $host "sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config"</div><div>    ssh $host "iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat"</div><div>    ssh $host "iptables -P FORWARD ACCEPT"</div><div>    ssh $host "swapoff -a"</div><div>    ssh $host "sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab"</div><div>    ssh $host "modprobe br_netfilter"</div><div>    ssh $host "modprobe ip_conntrack"</div><div>    scp tmp/kubernetes.conf $host:/etc/sysctl.d/</div><div>    ssh $host "sysctl -p /etc/sysctl.d/kubernetes.conf"</div><div>    scp tmp/ipvs.modules $host:/etc/sysconfig/modules/</div><div>    ssh $host "chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4"</div><div>ssh $host "chmod 755 /var/log"</div><div>done</div></div><div style="margin-top: 1em; margin-bottom: 1em;">    Step 5 检查配置</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>for host in $(cat remote-hosts)</div><div>do</div><div>    echo $host</div><div>    ssh $host "cat /etc/selinux/config"</div><div>    ssh $host "sysctl -a"</div><div>    ssh $host "lsmod | grep -e ip_vs -e nf_conntrack_ipv4"</div><div>    echo</div><div>done</div></div><div style="margin-top: 1em; margin-bottom: 1em;">    Step 6 配置Harbor的登录信息并传播到其他节点 （可选）</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cat /root/.docker/config.json</div><div>{</div><div>    "auths": {</div><div>        "reg.cre.com.hk": {</div><div>            "auth": "YWRtaW46SGFyYm9yMTIzNDU="</div><div>        }</div><div>    }</div><div>}</div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>for host in $(cat remote-hosts)</div><div>do</div><div>    echo $host</div><div>    ssh $host " mkdir -p /root/.docker/ "</div><div>    scp /root/.docker/config.json $host:/root/.docker/</div><div>    echo</div><div>done</div><div><br/></div><div><br/></div></div><div style="margin-top: 1em; margin-bottom: 1em;">四、安装docker和kubectl</div><div style="margin-top: 1em; margin-bottom: 1em;">1.安装docker-ce</div><div style="margin-top: 1em; margin-bottom: 1em;">  Step 1 配置docker-ce  配置文件</div><div style="margin-top: 1em; margin-bottom: 1em;"><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cat &gt; tmp/daemon.json &lt;&lt;EOF</div><div>{</div><div>    "oom-score-adjust": -1000,</div><div>    "log-driver":"json-file",</div><div>    "log-opts":{</div><div>        "max-size":"500m",</div><div>        "max-file":"3"</div><div>    },</div><div>    "max-concurrent-downloads": 10,</div><div>    "max-concurrent-uploads": 10,</div><div>    "graph":"/app/docker",</div><div>    "bip": "172.16.0.1/16",</div><div>    "insecure-registries":[</div><div>        "reg.cre.com.hk"</div><div>    ],</div><div>    "storage-driver":"overlay2",</div><div>    "storage-opts":[</div><div>        "overlay2.override_kernel_check=true"</div><div>    ]</div><div>}</div><div>EOF</div></div></div><div style="margin-top: 1em; margin-bottom: 1em;">   Step 2检查docker-ce特定版本，选择你要的版本进行安装</div><div style="margin-top: 1em; margin-bottom: 1em;"><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>yum list --showduplicates docker-ce|grep 19</div><div>yum list --showduplicates docker-ce|grep 20</div></div></div><div><br/></div><div>    <span style="font-weight: bold;">安装docker-ce 1.20 </span></div><div>    在所有Node机器上执行</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</div><div>yum -y install docker-ce</div><div>systemctl enable docker &amp;&amp; systemctl start docker</div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 10pt; font-family: 宋体;"> 配置镜像下载加速器：</span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</div><div><br/></div><div>{</div><div>  "registry-mirrors": ["https://b9pmyelo.mirror.aliyuncs.com"]</div><div>}</div><div>EOF</div><div>systemctl restart docker</div><div>docker info</div></div><div><br/></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;">   安装 docker-ce 19</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>for host in $(cat remote-hosts)</div><div>do</div><div>    ssh $host "yum install docker-ce-19.03.15 -y"</div><div>    ssh $host "mkdir /etc/docker"</div><div>    scp tmp/daemon.json $host:/etc/docker</div><div>ssh $host "systemctl enable docker"</div><div>ssh $host "systemctl start docker"</div><div>done</div></div><div style="margin-top: 1em; margin-bottom: 1em;"><br/></div><div style="margin-top: 1em; margin-bottom: 1em;">检查docker-ce状态</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>for host in $(cat remote-hosts)</div><div>do</div><div>    echo $host</div><div>ssh $host "docker info|grep -E \"Server Version|Logging Driver|Cgroup Driver|Docker Root Dir\""</div><div>    echo</div><div>done</div></div><div style="margin-top: 1em; margin-bottom: 1em;"><br/></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;">安装 1.20 版本 kubeadm  kubectl  kubelet</span></div><div style="margin-top: 1em; margin-bottom: 1em;">添加 yum 源</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</div><div>[kubernetes]</div><div>name=Kubernetes</div><div>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</div><div>enabled=1</div><div>gpgcheck=0</div><div>repo_gpgcheck=0</div><div>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</div><div>EOF</div></div><div>安装</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>yum install -y kubelet-1.20.0 kubeadm-1.20.0 kubectl-1.20.0</div><div>systemctl enable kubelet</div></div><div><br/></div><div><br/></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;">安装 1.18 版本 kubeadm  kubectl  kubelet</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>for host in $(cat remote-hosts)</div><div>do</div><div>echo $host</div><div>ssh $host "yum install -y kubeadm-1.18.16-0 kubectl-1.18.16-0 kubelet-1.18.16-0 "</div><div>ssh $host "systemctl enable kubelet"</div><div>echo</div><div>done</div></div><div><br/></div><div>三、安装etcd</div><div>1.下载cfssl工具，并配置证书</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</div><div>wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</div><div>wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</div><div>chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</div><div>mv cfssl_linux-amd64 /usr/local/bin/cfssl</div><div>mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</div><div>mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</div></div><div><br/></div><h4><span style="font-size: 13.3333px; font-family: 宋体;">自签证书颁发机构（CA）</span></h4><h4>创建工作目录</h4><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mkdir -p ~/etcd_tls</div><div>cd ~/etcd_tls</div><div><br/></div></div><div><br/></div><div>自签CA</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cat &gt; ca-config.json &lt;&lt; EOF</div><div>{</div><div>  "signing": {</div><div>    "default": {</div><div>      "expiry": "87600h"</div><div>    },</div><div>    "profiles": {</div><div>      "www": {</div><div>         "expiry": "87600h",</div><div>         "usages": [</div><div>            "signing",</div><div>            "key encipherment",</div><div>            "server auth",</div><div>            "client auth"</div><div>        ]</div><div>      }</div><div>    }</div><div>  }</div><div><br/></div><div><br/></div><div>}</div><div>EOF</div><div><br/></div><div>cat &gt; ca-csr.json &lt;&lt; EOF</div><div>{</div><div>    "CN": "etcd CA",</div><div>    "key": {</div><div>        "algo": "rsa",</div><div>        "size": 2048</div><div>    },</div><div>    "names": [</div><div>        {</div><div>            "C": "CN",</div><div>            "L": "Beijing",</div><div>            "ST": "Beijing"</div><div>        }</div><div>    ]</div><div>}</div><div>EOF</div></div><div><span style="color: rgb(31, 73, 125);">生成证书</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</div></div><div><br/></div><div><br/></div><div><br/></div><div><span style="color: rgb(31, 73, 125);">2. 使用自签CA签发Etcd HTTPS证书</span></div><div><span style="color: rgb(31, 73, 125);">创建证书申请文件：</span></div><div><font style="font-size: 10pt;"><span style="font-size: 10pt; color: rgb(227, 0, 0); font-family: 宋体;-en-paragraph:true;">注：下面</span><span style="font-size: 10pt; color: rgb(227, 0, 0); font-family: 宋体;-en-paragraph:true;">hosts</span><span style="font-size: 10pt; color: rgb(227, 0, 0); font-family: 宋体;-en-paragraph:true;">字段中</span><span style="font-size: 10pt; color: rgb(227, 0, 0); font-family: 宋体;-en-paragraph:true;">IP</span><span style="font-size: 10pt; color: rgb(227, 0, 0); font-family: 宋体;-en-paragraph:true;">为所有</span><span style="font-size: 10pt; color: rgb(227, 0, 0); font-family: 宋体;-en-paragraph:true;">etcd</span><span style="font-size: 10pt; color: rgb(227, 0, 0); font-family: 宋体;-en-paragraph:true;">节点的集群内部通信</span><span style="font-size: 10pt; color: rgb(227, 0, 0); font-family: 宋体;-en-paragraph:true;">IP</span><span style="font-size: 10pt; color: rgb(227, 0, 0); font-family: 宋体;-en-paragraph:true;">，一个都不能少！为了方便后期扩容可以多写几个预留的</span><span style="font-size: 10pt; color: rgb(227, 0, 0); font-family: 宋体;-en-paragraph:true;">IP</span><span style="font-size: 10pt; color: rgb(227, 0, 0); font-family: 宋体;-en-paragraph:true;">。</span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cat &gt; server-csr.json &lt;&lt; EOF</div><div><br/></div><div>{</div><div>    "CN": "etcd",</div><div>    "hosts": [</div><div>    "192.168.31.61",</div><div>    "192.168.31.62",</div><div>    "192.168.31.63"</div><div>    ],</div><div>    "key": {</div><div>        "algo": "rsa",</div><div>        "size": 2048</div><div>    },</div><div>    "names": [</div><div>        {</div><div>            "C": "CN",</div><div>            "L": "BeiJing",</div><div>            "ST": "BeiJing"</div><div>        }</div><div>    ]</div><div>}</div><div>EOF</div></div><div><br/></div><div><span style="color: rgb(31, 73, 125);">生成证书</span></div><div><span style="color: rgb(31, 73, 125);">会生成server.pem和server-key.pem文件。</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server</div></div><div><br/></div><div><span style="color: rgb(31, 73, 125);">3.安装部署ETCD</span></div><div><span style="color: rgb(31, 73, 125);">下载ETCD二进制安装包</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>wget   https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz</div></div><div><br/></div><div><span style="color: rgb(31, 73, 125);">创建工作目录并解压二进制包</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="color: rgb(31, 73, 125); font-family: unset; font-size: unset;">mkdir /opt/etcd/{bin,cfg,ssl} -p</span></div><div><span style="color: rgb(31, 73, 125); font-family: unset; font-size: unset;">tar zxvf etcd-v3.4.9-linux-amd64.tar.gz</span></div><div><span style="color: rgb(31, 73, 125); font-family: unset; font-size: unset;">mv etcd-v3.4.9-linux-amd64/{etcd,etcdctl} /opt/etcd/bin/</span></div></div><div><br/></div><div>创建ETCD配置文件，注意，红色部分，后续要修改成不同节点的IP和NAME</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF</div><div>#[Member]</div><div><font style="color: rgb(255, 0, 0);">ETCD_NAME="etcd-1"</font></div><div><font style="color: rgb(255, 0, 0);">ETCD_DATA_DIR="/var/lib/etcd/default.etcd"</font></div><div><font style="color: rgb(255, 0, 0);">ETCD_LISTEN_PEER_URLS="https://10.0.158.55:2380"</font></div><div><font style="color: rgb(255, 0, 0);">ETCD_LISTEN_CLIENT_URLS="https://10.0.158.55:2379"</font></div><div><br/></div><div><br/></div><div>#[Clustering]</div><div>ETCD_INITIAL_ADVERTISE_PEER_URLS="https://10.0.158.55:2380"</div><div>ETCD_ADVERTISE_CLIENT_URLS="https://10.0.158.55:2379"</div><div>ETCD_INITIAL_CLUSTER="etcd-1=https://10.0.158.55:2380,etcd-2=https://10.0.158.56:2380,etcd-3=https://10.0.158.57:2380"</div><div>ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"</div><div>ETCD_INITIAL_CLUSTER_STATE="new"</div><div>EOF</div></div><div><br/></div><div>4.使用systemd管理ETCD</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF</div><div>[Unit]</div><div>Description=Etcd Server</div><div>After=network.target</div><div>After=network-online.target</div><div>Wants=network-online.target</div><div>[Service]</div><div>Type=notify</div><div>EnvironmentFile=/opt/etcd/cfg/etcd.conf</div><div>ExecStart=/opt/etcd/bin/etcd \</div><div>--cert-file=/opt/etcd/ssl/server.pem \</div><div>--key-file=/opt/etcd/ssl/server-key.pem \</div><div>--peer-cert-file=/opt/etcd/ssl/server.pem \</div><div>--peer-key-file=/opt/etcd/ssl/server-key.pem \</div><div>--trusted-ca-file=/opt/etcd/ssl/ca.pem \</div><div>--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \</div><div>--logger=zap</div><div>Restart=on-failure</div><div>LimitNOFILE=65536</div><div>[Install]</div><div>WantedBy=multi-user.target</div><div>EOF</div></div><div><br/></div><div><br/></div><div><span style="color: rgb(31, 73, 125);">把刚才生成的证书拷贝到配置文件中的路径：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cp ~/etcd_tls/ca*pem ~/etcd_tls/server*pem /opt/etcd/ssl/</div></div><div><br/></div><div><span style="color: rgb(31, 73, 125);">启动ETCD和开机自启</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>systemctl daemon-reload</div><div>systemctl restart etcd</div><div>systemctl enable etcd</div></div><div><br/></div><div><span style="color: rgb(31, 73, 125);">拷贝master01上的ETCD配置到Master02和master03, </span><span style="color: rgb(31, 73, 125);">然后在节点2和节点3分别修改etcd.conf配置文件中的节点名称和当前服务器IP：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>scp -r /opt/etcd/ root@10.0.158.56:/opt/</div><div>scp /usr/lib/systemd/system/etcd.service root@10.0.158.56:/usr/lib/systemd/system/</div><div>scp -r /opt/etcd/ root@10.0.158.57:/opt/</div><div>scp /usr/lib/systemd/system/etcd.service root@10.0.158.57:/usr/lib/systemd/system/</div></div><div><br/></div><div><br/></div><div>查看ETCD集群状态，如下就是成功了。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>ETCDCTL_API=3 /opt/etcd/bin/etcdctl \</div><div>--cacert=/opt/etcd/ssl/ca.pem \</div><div>--cert=/opt/etcd/ssl/server.pem \</div><div>--key=/opt/etcd/ssl/server-key.pem \</div><div>--endpoints="https://10.0.158.55:2379,https://10.0.158.56:2379,https://10.0.158.57:2379" \</div><div>endpoint health --write-out=table</div><div><br/></div><div><br/></div><div>+--------------------------+--------+-------------+-------+</div><div>|         ENDPOINT         | HEALTH |    TOOK     | ERROR |</div><div>+--------------------------+--------+-------------+-------+</div><div>| https://10.0.158.57:2379 |   true | 14.870477ms |       |</div><div>| https://10.0.158.56:2379 |   true | 15.646466ms |       |</div><div>| https://10.0.158.55:2379 |   true | 16.025142ms |       |</div><div>+--------------------------+--------+-------------+-------+</div></div><div><br/></div><div><br/></div><div>五、初始化Master节点</div><div>1.使用自装ETCD方式的部署初始化master</div><div>   注：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cat &gt; kubeadm-config.yaml &lt;&lt; EOF</div><div>apiVersion: kubeadm.k8s.io/v1beta2</div><div>bootstrapTokens:</div><div>- groups:</div><div>  - system:bootstrappers:kubeadm:default-node-token</div><div>  token: 9037x2.tcaqnpaqkra9vsbw</div><div>  ttl: 24h0m0s</div><div>  usages:</div><div>  - signing</div><div>  - authentication</div><div>kind: InitConfiguration</div><div>localAPIEndpoint:</div><div>  advertiseAddress:  10.0.158.55</div><div>  bindPort: 6443</div><div>nodeRegistration:</div><div>  criSocket: /var/run/dockershim.sock</div><div>  name: master01</div><div>  taints:</div><div>  - effect: NoSchedule</div><div>    key: node-role.kubernetes.io/master</div><div>---</div><div>apiServer:</div><div>  certSANs:  # 包含所有Master/LB/VIP IP，一个都不能少！为了方便后期扩容可以多写几个预留的IP。</div><div>  - master01</div><div>  - master02</div><div>  - master03</div><div>  - 10.0.158.55</div><div>  - 10.0.158.56</div><div>  - 10.0.158.57</div><div>  - 10.0.158.253</div><div>  - 127.0.0.1</div><div>  extraArgs:</div><div>    authorization-mode: Node,RBAC</div><div>  timeoutForControlPlane: 4m0s</div><div>apiVersion: kubeadm.k8s.io/v1beta2</div><div>certificatesDir: /etc/kubernetes/pki</div><div>clusterName: kubernetes</div><div>controlPlaneEndpoint: 10.0.158.253:6443 # 负载均衡虚拟IP（VIP）和端口</div><div>controllerManager: {}</div><div>dns:</div><div>  type: CoreDNS</div><div>etcd:</div><div>  external:  # 使用外部etcd</div><div>    endpoints:</div><div>    - https://10.0.158.55:2379 # etcd集群3个节点</div><div>    - https://10.0.158.56:2379</div><div>    - https://10.0.158.57:2379</div><div>    caFile: /opt/etcd/ssl/ca.pem # 连接etcd所需证书</div><div>    certFile: /opt/etcd/ssl/server.pem</div><div>    keyFile: /opt/etcd/ssl/server-key.pem</div><div>imageRepository: reg.cre.com.hk/google_containers # 由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址</div><div>kind: ClusterConfiguration</div><div>kubernetesVersion: v1.20.0 # K8s版本，与上面安装的一致</div><div>networking:</div><div>  dnsDomain: cluster.local</div><div>  podSubnet: 10.244.0.0/16  # Pod网络，与下面部署的CNI网络组件yaml中保持一致</div><div>  serviceSubnet: 10.96.0.0/12  # 集群内部虚拟网络，Pod统一访问入口</div><div>scheduler: {}</div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">2.使用自生成配置文件，自生成ETCD集群</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>kubeadm config print init-defaults &gt; kubeadm-config.yaml</div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(31, 73, 125); font-family: Cambria;">  </span></div><div><span style="font-size: 10pt; color: rgb(31, 73, 125); font-family: Cambria;">  编辑</span><span style="color: rgb(31, 73, 125); font-family: Cambria;">kubeadm-config.yaml，修改如下：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>apiVersion: kubeadm.k8s.io/v1beta2</div><div>bootstrapTokens:</div><div>- groups:</div><div>  - system:bootstrappers:kubeadm:default-node-token</div><div>  token: abcdef.0123456789abcdef</div><div>  ttl: 24h0m0s</div><div>  usages:</div><div>  - signing</div><div>  - authentication</div><div>kind: InitConfiguration</div><div>localAPIEndpoint:</div><div>  advertiseAddress: 10.0.158.55</div><div>  bindPort: 6443</div><div>nodeRegistration:</div><div>  criSocket: /var/run/dockershim.sock</div><div>  name: master01</div><div>  taints:</div><div>  - effect: NoSchedule</div><div>    key: node-role.kubernetes.io/master</div><div>---</div><div>apiServer:</div><div>  timeoutForControlPlane: 4m0s</div><div>  extraVolumes:</div><div>  - hostPath: /etc/localtime</div><div>    mountPath: /etc/localtime</div><div>    name: localtime</div><div>    readOnly: true</div><div>apiVersion: kubeadm.k8s.io/v1beta2</div><div>certificatesDir: /etc/kubernetes/pki</div><div>clusterName: kubernetes</div><div>controllerManager: {}</div><div>  extraArgs:</div><div>    bind-address: "0.0.0.0"</div><div>    experimental-cluster-signing-duration: 867000h</div><div>  extraVolumes:</div><div>  - hostPath: /etc/localtime</div><div>    mountPath: /etc/localtime</div><div>    name: localtime</div><div>    readOnly: true</div><div>dns:</div><div>  type: CoreDNS</div><div>etcd:</div><div>  local:</div><div>    dataDir: /var/lib/etcd</div><div>    extraArgs:</div><div>      auto-compaction-retention: "1h"</div><div>      max-request-bytes: "33554432"</div><div>      quota-backend-bytes: "8589934592"</div><div>      enable-v2: "false"</div><div>imageRepository: reg.cre.com.hk/kubernetes-18</div><div>kind: ClusterConfiguration</div><div>kubernetesVersion: v1.18.16</div><div>networking:</div><div>  dnsDomain: cluster.local</div><div>  serviceSubnet: 10.96.0.0/12</div><div>  podSubnet: 10.244.0.0/16</div><div>controlPlaneEndpoint: 10.0.158.253:6443</div><div>scheduler:</div><div>  extraArgs:</div><div>    bind-address: "0.0.0.0"</div><div>  extraVolumes:</div><div>    - hostPath: /etc/localtime</div><div>      mountPath: /etc/localtime</div><div>      name: localtime</div><div>      readOnly: true</div><div><br/></div><div><br/></div><div>---</div><div>apiVersion: kubeproxy.config.k8s.io/v1alpha1</div><div>kind: KubeProxyConfiguration</div><div>mode: ipvs</div><div><br/></div><div><br/></div><div>---</div><div>apiVersion: kubelet.config.k8s.io/v1beta1</div><div>kind: KubeletConfiguration</div><div>cgroupDriver: systemd</div><div>failSwapOn: true</div></div><div><span style="font-size: 16px;"><br/></span></div><div><span style="font-size: 16px; color: rgb(31, 73, 125); font-family: Cambria;">初始化Master1，在第一个Master上执行</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>kubeadm init --config kubeadm-config.yaml</div></div><div><span style="font-size: 12pt;"><br/></span></div><div>生成kubectl配置</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mkdir -p $HOME/.kube</div><div>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</div><div>sudo chown $(id -u):$(id -g) $HOME/.kube/config</div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 16px; color: rgb(31, 73, 125); font-family: Cambria;">配置kubectl命令自动补全</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>yum install bash-completion -y</div><div>source /usr/share/bash-completion/bash_completion</div><div>source &lt;(kubectl completion bash)</div><div>echo "source &lt;(kubectl completion bash)" &gt;&gt; ~/.bashrc</div><div>alias kcl=kubectl</div><div>complete -F __start_kubectl kcl</div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 16px; color: rgb(31, 73, 125); font-family: Cambria;">将相关配置拷贝到另两个master</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>scp -r /etc/kubernetes/pki/ 10.0.158.56:/etc/kubernetes/</div><div>scp -r /etc/kubernetes/pki/ 10.0.158.57:/etc/kubernetes/</div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 16px;"><span style="font-size: 16px; color: rgb(31, 73, 125); font-family: Cambria;">复制Master1初始化后生成的如下命令，在2和3上执行，</span><span style="font-size: 16px; color: rgb(227, 0, 0); font-family: Cambria;">注意，一定是你自已生成的，不要复制</span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>kubeadm join 10.0.158.253:6443 --token 9037x2.tcaqnpaqkra9vsbw     --discovery-token-ca-cert-hash sha256:7a5a253d0e0cced9ba13e1eb908672a245d0bd6c1e21fde2dba1bc70c04a5874     --control-plane</div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 16px; color: rgb(31, 73, 125); font-family: Cambria;">查看K8S集群信息</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>curl -k  https://10.0.158.253:6443/version</div><div>{</div><div>  "major": "1",</div><div>  "minor": "20",</div><div>  "gitVersion": "v1.20.0",</div><div>  "gitCommit": "af46c47ce925f4c4ad5cc8d1fca46c7b77d13b38",</div><div>  "gitTreeState": "clean",</div><div>  "buildDate": "2020-12-08T17:51:19Z",</div><div>  "goVersion": "go1.15.5",</div><div>  "compiler": "gc",</div><div>  "platform": "linux/amd64"</div><div>}</div></div><div><span style="font-size: 12pt;"><br/></span></div><div>六、加入node节点</div><div>  </div><div> 1.在Node节点上执行如下命令，带 --control-plane参数的是初始化成Master</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>kubeadm join 10.0.158.253:6443 --token 9037x2.tcaqnpaqkra9vsbw     --discovery-token-ca-cert-hash sha256:7a5a253d0e0cced9ba13e1eb908672a245d0bd6c1e21fde2dba1bc70c04a5874</div></div><div><br/></div><div>部署calico</div><div>calico.yaml可去官网下载</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>kubectl apply -f calico.yaml</div><div>kubectl get pods -n kube-system</div></div><div><br/></div><div><br/></div><div>七、部署 Dashboard</div><div><br/></div><div><span style="font-family: 宋体;">访问地址：<a href="https://nodeip:30001/" style="font-family: 宋体;">https://NodeIP:30001</a></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>kubectl apply -f kubernetes-dashboard.yaml</div><div>kubectl get pods -n kubernetes-dashboard</div></div><div><br/></div><div>创建service account并绑定默认cluster-admin管理员集群角色：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>kubectl create serviceaccount dashboard-admin -n kube-system</div><div>kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</div><div>kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}')</div></div><div><span style="font-size: 10pt; font-family: 宋体;">使用输出的token登录Dashboard</span></div><div><span style="font-size: 10pt;"><br/></span></div><div><span style="font-size: 10pt;"><br/></span></div><div><span style="font-size: 13.3333px; font-family: 宋体;">快速生成docker-registry secret</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>kubectl create secret docker-registry yyk8s-registrykey --docker-server=reg.cre.com.hk --docker-username=admin --docker-password=Harbor12345 --docker-email=admin@example.com -n kube-system</div><div><br/></div><div>kubectl create namespace sit-environment</div><div>kubectl create secret docker-registry yyk8s-registrykey --docker-server=reg.cre.com.hk --docker-username=admin --docker-password=Harbor12345 --docker-email=admin@example.com -n sit-environment</div><div><br/></div><div>kubectl create namespace uat-environment</div><div>kubectl create secret docker-registry yyk8s-registrykey --docker-server=reg.cre.com.hk --docker-username=admin --docker-password=Harbor12345 --docker-email=admin@example.com -n uat-environment</div><div><br/></div><div>kubectl create namespace prod-environment</div><div>kubectl create secret docker-registry yyk8s-registrykey --docker-server=reg.cre.com.hk --docker-username=admin --docker-password=Harbor12345 --docker-email=admin@example.com -n prod-environment</div><div><br/></div><div>kubectl create namespace devops-environment</div><div>kubectl create secret docker-registry yyk8s-registrykey --docker-server=reg.cre.com.hk --docker-username=admin --docker-password=Harbor12345 --docker-email=admin@example.com -n devops-environment</div><div><br/></div><div>kubectl create namespace ingress-nginx</div><div>kubectl create secret docker-registry yyk8s-registrykey --docker-server=reg.cre.com.hk --docker-username=admin --docker-password=Harbor12345 --docker-email=admin@example.com -n ingress-nginx</div></div><div><br/></div><div><br/></div></div><div>杂记：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>docker tag registry.aliyuncs.com/google_containers/kube-proxy:v1.20.0 reg.cre.com.hk/google_containers/kube-proxy:v1.20.0</div><div>docker tag registry.aliyuncs.com/google_containers/kube-controller-manager:v1.20.0 reg.cre.com.hk/google_containers/kube-controller-manager:v1.20.0</div><div>docker tag registry.aliyuncs.com/google_containers/kube-apiserver:v1.20.0 reg.cre.com.hk/google_containers/kube-apiserver:v1.20.0</div><div>docker tag registry.aliyuncs.com/google_containers/kube-scheduler:v1.20.0 reg.cre.com.hk/google_containers/kube-scheduler:v1.20.0</div><div>docker tag registry.aliyuncs.com/google_containers/coredns:1.7.0 reg.cre.com.hk/google_containers/coredns:1.7.0</div><div>docker tag registry.aliyuncs.com/google_containers/pause:3.2 reg.cre.com.hk/google_containers/pause:3.2</div></div><div><br/></div></body></html>